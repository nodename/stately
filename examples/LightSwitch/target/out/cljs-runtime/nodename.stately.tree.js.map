{"version":3,"sources":["nodename/stately/tree.cljs"],"mappings":"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","names":["nodename.stately.tree/state-tree","state-machines","root-fsm-key","component-keys","state-key","fsm","state","cljs.core.get","component-state-trees","p1__36697#","cljs.core.mapv","key-and-components","cljs.core.apply","cljs.core/merge","root-fsm","root-fsm-states","p1__36699#","cljs.core.map","cljs.core/keys","nodename.stately.tree/parent-links","m","root-key","ks","kvs","cljs.core.interleave","cljs.core.repeat","trees","p1__36727#","sub-kvs","p1__36728#","p2__36729#","cljs.core/flatten","cljs.core.concat","nodename.stately.tree/parent-map","tree","cljs.core/assoc","nodename.stately.tree/set-state-tree!","parents","cljs.core.swap_BANG_","nodename.stately.comms/app-db","nodename.stately.tree/tree","cljs.core/deref","nodename.stately.tree/super","k","parent-map","p","nodename.stately.tree/active-states","nodename.stately.tree/set-active-states!","states","nodename.stately.tree/path-to-root","state-kw","G__36743","nodename.stately.tree/lca-path","from-state","to-state","cljs.core._EQ_","exit-path","cljs.core/reverse","entrance-path","exit","entrance","and__5000__auto__","cljs.core/first","cljs.core/rest"],"sourcesContent":["(ns nodename.stately.tree\n  (:require [nodename.stately.comms :refer [app-db]]))\n\n\n;; TREE ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\n\n\n\n(defn- state-tree\n  [state-machines root-fsm-key]\n  (let [;; component-keys: return the components of the state `state-key` in `fsm`\n        component-keys (fn [state-key fsm]\n                         (let [state (get (:states fsm) state-key)]\n                           (:components state)))\n\n        component-state-trees (fn [state-key fsm]\n                                (mapv #(state-tree state-machines %)\n                                      (component-keys state-key fsm)))\n\n        key-and-components (fn [state-key fsm]\n                             {state-key (apply merge {} (component-state-trees state-key fsm))})\n\n        root-fsm (get state-machines root-fsm-key)\n        root-fsm-states (:states root-fsm)]\n    {root-fsm-key (apply merge (map #(key-and-components % root-fsm)\n                                    (keys root-fsm-states)))}))\n\n\n(defn- parent-links\n  [m root-key]\n  (let [ks (keys m)\n        kvs (interleave ks (repeat root-key))\n        trees (map #(get m %) ks)\n        sub-kvs (map #(parent-links %1 %2) trees ks)]\n    (flatten (concat kvs sub-kvs))))\n\n(defn- parent-map\n  [tree]\n  (let [kvs (parent-links tree nil)]\n    (apply assoc {} kvs)))\n\n(defn set-state-tree!\n  [state-machines root-fsm-key]\n  (let [tree (state-tree state-machines root-fsm-key)\n        parents (parent-map tree)]\n    (swap! app-db assoc\n           :tree tree\n           :parents parents)))\n\n(defn tree\n  []\n  (:tree @app-db))\n\n\n(defn super\n  \"Given a state-key, return its superstate;\n  given an fsm-key, return its super-fsm\"\n  [k]\n  (let [parent-map (:parents @app-db)\n        p (get parent-map k)]\n    (get parent-map p)))\n\n\n\n;; ACTIVE STATES ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\n\n\n\n(defn active-states\n  []\n  (get @app-db :active-states))\n\n(defn set-active-states!\n  [states]\n  (swap! app-db assoc :active-states states))\n\n\n\n;; LEAST COMMON ANCESTOR ;;;;;;;;;;;;;;;;;;;;;;;;;\n\n\n\n(defn- path-to-root\n  [state-kw]\n  (if (nil? state-kw)\n    []\n    (concat [state-kw] (path-to-root (super state-kw)))))\n\n\n(defn lca-path\n  \"Return states-to-exit and states-to-enter,\n  which constitute the path from from-state to to-state\n  via least common ancestor\"\n  [from-state to-state]\n  (cond (= :internal to-state) [[] []]\n        (= from-state to-state) [[from-state] [to-state]]\n        :else (let [exit-path (reverse (path-to-root from-state))\n                    entrance-path (reverse (path-to-root to-state))]\n                (loop [exit exit-path\n                       entrance entrance-path]\n                  (if (and (first exit)\n                           (= (first exit) (first entrance)))\n                    (recur (rest exit) (rest entrance))\n                    [(reverse exit) entrance])))))"]}